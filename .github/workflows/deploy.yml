# 工作流的名称，会显示在 GitHub Actions 页面
name: Deploy to Google Cloud Run

# 触发工作流的事件
on:
  # 当有代码推送到 main 分支时触发
  push:
    branches: [ "main" ]

# 工作流包含的任务
jobs:
  deploy:
    # 运行此任务所需的权限
    permissions:
      contents: 'read'
      id-token: 'write'

    # 任务运行的环境
    runs-on: ubuntu-latest

    # 任务包含的步骤
    steps:
      # 第一步：检出代码
      # 拉取你的仓库代码到 Actions 的运行环境中
      - name: Checkout repository
        uses: actions/checkout@v4

      # 第二步：通过服务账户密钥向 Google Cloud 进行身份验证
      # 这里会使用我们之前设置的名为 GCP_SA_KEY 的 Secret
      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 第三步：设置 gcloud CLI
      # 安装并配置 Google Cloud 的命令行工具
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # 第四步：构建并推送容器镜像到 Artifact Registry
      # 运行我们之前手动执行过的构建命令
      - name: Build and Push Container Image
        run: |-
          gcloud builds submit --tag us-central1-docker.pkg.dev/sigma-outcome/cloud-run-source-deploy/color-palette

      # 第五步：部署容器到 Cloud Run
      # 运行我们之前手动执行过的部署命令，使用我们最终确定的服务名称
      - name: Deploy to Cloud Run
        run: |-
          gcloud run deploy color-palette \
            --image us-central1-docker.pkg.dev/sigma-outcome/cloud-run-source-deploy/color-palette \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --port 80